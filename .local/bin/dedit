#!/bin/bash

# Check for input
if [ -z "$1" ]; then
    echo "Usage: dedit <partial-app-name>"
    exit 1
fi

# Escape regex chars
escaped=$(printf '%s\n' "$1" | sed -E 's/[][\.^$*+?{}()|\\/]/\\&/g')

# Search in both local and system dirs
matches=$(grep -ril "Name=.*$escaped" ~/.local/share/applications /usr/share/applications 2>/dev/null)

# Check if any matches found
if [ -z "$matches" ]; then
    echo "No .desktop file found matching '$1'"
    exit 1
fi

# Pick best match â€” prioritizing local override if present
best_match=$(echo "$matches" | sort | head -n 1)
filename=$(basename "$best_match")
local_path="$HOME/.local/share/applications/$filename"

# If match is already local, just open it
if [[ "$best_match" == "$local_path" ]]; then
    echo "Editing existing local file: $local_path"
    code "$local_path"
    exit 0
fi

# Otherwise, copy system file to local
if [ ! -f "$local_path" ]; then
    echo "Creating local override: $local_path"
    cp "$best_match" "$local_path"
else
    echo "Local override already exists: $local_path"
fi

echo "Opening: $local_path"
code "$local_path"
